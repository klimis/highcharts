<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
<script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>

<div class="main container-fluid">
  <h1>Highcharts Projection Explorer</h1>

  <div class="row">
    <div class="col-lg-8">
      <div id="container"></div>
    </div>
  </div>

  <script>
    (async () => {
      // Get random data for this sample
      function getRandomData(topology) {
        return topology.objects.default.geometries.map(() =>
          Math.round(Math.random() * 100)
        );
      }
      function calculatePercentileDataClasses(data) {
        const values = data
          .map((item) => item.value || item[1] || item)
          .filter((val) => val !== null && val !== undefined && !isNaN(val));

        const sorted = values.slice().sort((a, b) => a - b);

        if (sorted.length === 0) return [];

        const getPercentile = (arr, p) => {
          const index = Math.max(
            0,
            Math.min(Math.floor(arr.length * p), arr.length - 1)
          );
          return arr[index];
        };

        // Calculate quintiles (20%, 40%, 60%, 80%)
        const percentiles = [
          sorted[0], // 0% (min)
          getPercentile(sorted, 0.2), // 20th percentile
          getPercentile(sorted, 0.4), // 40th percentile
          getPercentile(sorted, 0.6), // 60th percentile
          getPercentile(sorted, 0.8), // 80th percentile
          sorted[sorted.length - 1], // 100% (max)
        ];

        const colors = ["#E6A532", "#F0CD91", "#F0CD91", "#AAB9E1", "#2D50A0"];

        return colors.map((color, i) => ({
          from: percentiles[i],
          //to: i < colors.length - 1 ? percentiles[i + 1] : undefined,
          to: percentiles[i + 1],
          color: color,
        }));
      }

      const topology = await fetch(
        "https://code.highcharts.com/mapdata/custom/world.topo.json"
      ).then((response) => response.json());

      const antarctica = await fetch(
        "https://code.highcharts.com/mapdata/custom/antarctica.topo.json"
      ).then((response) => response.json());

      const data = getRandomData(topology);

      const dataClasses = calculatePercentileDataClasses(data);
      console.log("Data Classes:", dataClasses);
      let chart;

      const drawMap = (projectionKey) => {
        // Initialize the chart
        if (!chart) {
          console.time("@mapChart");

          chart = Highcharts.mapChart("container", {
            chart: {
              height: "65%",
              spacing: [10, 1, 10, 1],
            },

            title: {
              text: undefined,
            },

            legend: {
              enabled: true,
              floating: true,
              align: "left",
              verticalAlign: "bottom",
              layout: "horizontal",
              borderWidth: 2,
              backgroundColor: "lightgray",
              transparent: true,
              borderColor: "white",
              itemStyle: {
                fontSize: "0.8rem",
              },
            },

            mapNavigation: {
              enabled: true,
              enableDoubleClickZoomTo: true,
              buttonOptions: {
                verticalAlign: "top",
              },
            },

            mapView: {
              // projection,

              projection: {
                name: "WebMercator",
              },
              zoom: 2,
              center: [6.5, 61],
            },

            colorAxis: {
              dataClasses: dataClasses,
            },

            // colorAxis: {
            //   dataClasses: [
            //     {
            //       from: 0,
            //       to: 20,
            //       color: "#E6A532",
            //     },
            //     {
            //       from: 20,
            //       to: 40,
            //       color: "#F0CD91",
            //     },
            //     {
            //       from: 40,
            //       to: 60,
            //       color: "#F0CD91",
            //     },
            //     {
            //       from: 60,
            //       to: 80,
            //       color: "#AAB9E1",
            //     },
            //     {
            //       from: 80,
            //       color: "#2D50A0",
            //     },
            //   ],
            // },

            tooltip: {
              pointFormat:
                "<strong>{point.name}</strong> <br/> Score: <strong>{point.value}</strong> <br/>Position: <strong>{point.value}th of 195 countries</strong> <br/> <i>Bottom Performer</i>",
            },

            plotOptions: {
              series: {
                animationLimit: 500,
                states: {
                  inactive: {
                    opacity: 1,
                  },
                },
              },
              mapline: {
                enableMouseTracking: false,
              },
            },

            series: [
              {
                data,
                mapData: topology,
                joinBy: null,
                name: "Global Health Security Index",
                dataLabels: {
                  enabled: false,
                  format: "{point.name}",
                },
                clip: false,
              },
              {
                mapData: antarctica,
                allAreas: true,
                name: "Antarctica",
                clip: false,
                opacity: 0.75,
              },

              //   {
              //     type: "mappoint",
              //     data: [
              //       {
              //         geometry: {
              //           type: "Point",
              //           coordinates: [4.9, 53.38],
              //         },
              //         name: "Amsterdam",
              //       },
              //       {
              //         geometry: {
              //           type: "Point",
              //           coordinates: [-118.24, 34.05],
              //         },
              //         name: "LA",
              //       },
              //     ],
              //     color: "#3030d0",
              //   },
            ],
          });
          console.timeEnd("@mapChart");
        } else {
          chart.update({
            mapView: {
              projection,
            },
          });
        }

        // Toggle buttons
      };

      drawMap("equalearth");
    })();
  </script>
</div>

<style>
  * {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
      sans-serif;
  }

  .main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
  }

  #container {
    min-width: 310px;
    max-width: 800px;
    margin: 0 auto;
  }

  .main #small-world-container {
    max-width: 150px;
    margin-top: 1rem;
    min-width: 75px;
    height: 150px;
  }

  .main h1 {
    font-size: 1.5rem !important;
  }

  .main .mt-4 {
    margin-top: 1.5rem !important;
    min-width: 25%;
  }

  .main .loading {
    margin-top: 10em;
    text-align: center;
    color: gray;
  }

  .main .btn-group {
    flex-wrap: wrap;
  }

  .main .btn {
    line-height: 1.5;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    margin: 0.1rem 0;
  }

  #descriptions div {
    display: none;
  }
</style>
