<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
<script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>

<div class="main container-fluid">
  <div style="text-align: center; margin-bottom: 1rem">
    <ul>
      <li>
        <a href="/map.html?index_code=imp_sdg_07_40"
          >Share of renewable energy in gross final energy consumption</a
        >
      </li>
      <li>
        <a href="/map.html?index_code=imp_sdg_12_31">Consumption footprint</a>
      </li>
      <li>
        <a href="/map.html?index_code=imp_educ_uoe_grad04"
          >Women Graduates in STEM per 1000 of population</a
        >
      </li>
      <li>
        <a href="/map.html?index_code=imp_sdg_01_10"
          >People at risk of poverty or social exclusion</a
        >
      </li>
    </ul>
    <h1 id="indicator"></h1>
  </div>
  <div class="row">
    <div class="col-lg-8">
      <div id="container"></div>
    </div>
  </div>

  <script>
    (async () => {
      function calculatePercentileDataClasses(data) {
        const values = data
          .map((item) => item.value || item[1] || item)
          .filter((val) => val !== null && val !== undefined && !isNaN(val));

        const sorted = values.slice().sort((a, b) => a - b);

        if (sorted.length === 0) return [];

        const getPercentile = (arr, p) => {
          const index = Math.max(
            0,
            Math.min(Math.floor(arr.length * p), arr.length - 1)
          );
          return arr[index];
        };

        // Calculate quintiles (20%, 40%, 60%, 80%)
        const percentiles = [
          sorted[0], // 0% (min)
          getPercentile(sorted, 0.2), // 20th percentile
          getPercentile(sorted, 0.4), // 40th percentile
          getPercentile(sorted, 0.6), // 60th percentile
          getPercentile(sorted, 0.8), // 80th percentile
          sorted[sorted.length - 1], // 100% (max)
        ];

        const colors = ["#E6A532", "#F0CD91", "#AAB9E1", "#6487C3", "#2D50A0"];

        return colors.map((color, i) => ({
          from: percentiles[i],
          to: percentiles[i + 1],
          color: color,
        }));
      }

      function calculatePercentiles(data) {
        const values = data
          .map((item) => item.value || item[1] || item)
          .filter((val) => val !== null && val !== undefined && !isNaN(val));

        const sorted = values.slice().sort((a, b) => a - b);

        if (sorted.length === 0) return [];

        const getPercentile = (arr, p) => {
          const index = Math.max(
            0,
            Math.min(Math.floor(arr.length * p), arr.length - 1)
          );
          return arr[index];
        };

        // Calculate quintiles (20%, 40%, 60%, 80%)
        const percentiles = [
          sorted[0], // 0% (min)
          getPercentile(sorted, 0.2), // 20th percentile
          getPercentile(sorted, 0.4), // 40th percentile
          getPercentile(sorted, 0.6), // 60th percentile
          getPercentile(sorted, 0.8), // 80th percentile
          sorted[sorted.length - 1], // 100% (max)
        ];

        return percentiles;
      }

      const topology = await fetch(
        "https://code.highcharts.com/mapdata/custom/world.topo.json"
      ).then((response) => response.json());

      const antarctica = await fetch(
        "https://code.highcharts.com/mapdata/custom/antarctica.topo.json"
      ).then((response) => response.json());

      const urlParams = new URLSearchParams(window.location.search);
      const indexCode = urlParams.get("index_code") || "imp_sdg_07_40";

      const data = await fetch(
        "https://impact.api.coin-dev.eu/api/v1/en/map/high?index_code=" +
          indexCode
      ).then((response) => response.json());

      const info = await fetch(
        "https://impact.api.coin-dev.eu/api/v1/en/info?index_code=" + indexCode
      ).then((response) => response.json());

      console.log("direction:", info.data.attributes.target2029Baseline2024);
      document.getElementById("indicator").innerText = info.data.name;
      const reverse =
        info.data.attributes.target2029Baseline2024 === "-" ? true : false;

      const dataClasses = calculatePercentileDataClasses(data);
      //reverse the order of dataClasses to have the lowest value first

      if (reverse) {
        dataClasses.reverse();
      }
      //dataClasses.reverse();
      const percentiles = calculatePercentiles(data);

      let chart;
      Highcharts.setOptions({
        lang: {
          thousandsSep: "",
          decimalPoint: ".",
        },
      });

      Highcharts.mapChart("container", {
        chart: {
          height: "65%",
          spacing: [10, 1, 10, 1],
          events: {
            load: function () {
              //find items with class "highcharts-point inside class highcharts-legend-item"
              const legendItems = document.querySelectorAll(
                ".highcharts-legend-item"
              );
              legendItems.forEach((item, index) => {
                const point = item.querySelector(".highcharts-point");
                if (point) {
                  point.style.width = 60;
                }
              });
              //at the very end of item .highcharts-legend add some text

              //   const legend = document.querySelector(".highcharts-legend");
              //   if (legend) {
              //     console.log("Legend Element:", legend);
              //     const legendText = document.createElement("span");
              //     legendText.innerHTML =
              //       "<strong>Legend:</strong> The range of scores is aa";
              //     legend.appendChild(legendText);
              //   }
            },
          },
        },

        title: {
          text: "",
        },

        legend: {
          title: {
            //if reverse is true, then the legend will be reversed
            text: reverse
              ? "The range of scores is divided into five equal parts (quintiles) <br/>\
              <span style='float: right; font-weight: bold;padding-right:5px'>Bottom</span> \
             <span style='float: left; font-weight: bold;padding-left:5px'>Top</span>"
              : "The range of scores is divided into five equal parts (quintiles) <br/><span style='float: left; font-weight: bold;padding-left:5px'>Bottom</span> \
             <span style='float: right; font-weight: bold;padding-right:5px'>Top</span>",
            //if reverse is true, then the legend will be reversed
            //
            // text: "The range of scores is divided into five equal parts (quintiles). \
            //  <br/><span style='float: left; font-weight: bold;padding-left:5px'>Bottom</span> \
            //  <span style='float: right; font-weight: bold;padding-right:5px'>Top</span>",
            style: {
              color: "black",
              fontWeight: "normal",
            },
          },
          enabled: true,
          floating: true,
          align: "left",
          verticalAlign: "bottom",
          layout: "horizontal",
          borderWidth: 2,
          backgroundColor: "lightgray",
          transparent: true,
          borderColor: "white",
          symbolRadius: 0,
          symbolWidth: 27,
          symbolHeight: 14,
          squareSymbol: true,
          symbolPadding: 23,
          useHTML: true,
          labelFormatter: function () {
            //console.log("Label Formatter:", this.from);
            if (this.from < 12) {
              //return "Bottom";
            }

            if (this.to === undefined) {
              return "Above " + this.from;
            }
            //return this.from + " - " + this.to;
            return "";
          },
        },

        mapNavigation: {
          enabled: true,
          enableDoubleClickZoomTo: true,
          buttonOptions: {
            verticalAlign: "top",
          },
        },

        mapView: {
          // projection,

          projection: {
            name: "WebMercator",
          },
          zoom: 3.2,
          center: [6.5, 55],
        },

        colorAxis: {
          dataClasses: dataClasses,
        },

        credits: {
          enabled: false,
        },
        tooltip: {
          pointFormat:
            "<strong>{point.name}</strong> <br/> Score: <strong>{point.value}</strong> <br/>Position: <strong>{point.value}th of 195 countries</strong> <br/> <i>Bottom Performer</i>",
        },

        plotOptions: {
          series: {
            animationLimit: 500,
            states: {
              inactive: {
                opacity: 1,
              },
            },
          },
          mapline: {
            enableMouseTracking: false,
          },
        },

        series: [
          {
            allAreas: true,
            data: data,
            mapData: topology,
            //joinBy: null,
            joinBy: ["iso-a2", "code"],
            name: "Global Health Security Index",
            dataLabels: {
              enabled: false,
              format: "{point.name}",
            },
            clip: false,
          },
          {
            mapData: antarctica,
            allAreas: true,
            name: "Antarctica",
            clip: false,
            opacity: 0.75,
          },
        ],
      });
    })();
  </script>
</div>

<style>
  * {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
      sans-serif;
  }

  .main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 10px;
  }

  #container {
    min-width: 310px;
    max-width: 800px;
    margin: 0 auto;
  }

  .main #small-world-container {
    max-width: 150px;
    margin-top: 1rem;
    min-width: 75px;
    height: 150px;
  }

  .main h1 {
    font-size: 1.5rem !important;
  }

  .main .mt-4 {
    margin-top: 1.5rem !important;
    min-width: 25%;
  }

  .main .loading {
    margin-top: 10em;
    text-align: center;
    color: gray;
  }

  .main .btn-group {
    flex-wrap: wrap;
  }

  .main .btn {
    line-height: 1.5;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    margin: 0.1rem 0;
  }

  #descriptions div {
    display: none;
  }
  /**
    * Add some basic styles for the ul li links    
    */
  .main ul {
    list-style-type: none;
    padding: 0;
  }
  .main ul li {
    margin: 0.5rem 0;
  }
  .main ul li a {
    text-decoration: none;
    color: #007bff;
  }
  .main ul li a:hover {
    text-decoration: underline;
  }
  .main ul li a:visited {
    color: #0056b3;
  }
</style>
