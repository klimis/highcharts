<script src="highcharts/highmaps.js"></script>
<script src="highcharts/exporting.js"></script>
<!--
https://code.highcharts.com/maps/modules/exporting.js
https://code.highcharts.com/maps/highmaps.js
https://code.highcharts.com/mapdata/custom/world.topo.json
-->

<div id="container"></div>
<script>
  (async () => {
    const topology = await fetch("highcharts/world.topo.json").then(
      (response) => response.json()
    );

    const urlParams = new URLSearchParams(window.location.search);
    const indexCode = urlParams.get("indicator_code") || "bop_fdi6_pos";
    const sectorCode = urlParams.get("sector_code") || "a";
    const data = await fetch(
      `https://api.sectoral.coin-dev.eu/api/data/map?indicator_code=${indexCode}&sector_code=${sectorCode}`
    ).then((response) => response.json());

    // Extract EU27 country IDs from the data for easy reference
    const eu27Countries = data
      .filter(
        (item) => item.id !== "jp" && item.id !== "cn" && item.id !== "us"
      )
      .map((item) => item.id);

    // Create the chart
    Highcharts.mapChart("container", {
      credits: {
        enabled: false,
      },
      chart: {
        map: topology,
        // zooming: {
        //   type: null,
        //   mouseWheel: {
        //     enabled: false,
        //   },
        // },
      },

      title: {
        text: "",
      },

      subtitle: {
        text: "",
      },

      mapNavigation: {
        enabled: false,
        buttonOptions: {
          verticalAlign: "bottom",
        },
      },
      mapView: {
        projection: {
          name: "WebMercator",
        },
        //Dynamically set zoom and center based on data

        zoom: data.some((item) => ["jp", "cn", "us"].includes(item.id))
          ? 1.5
          : 3,
        center: data.some((item) => ["jp", "cn", "us"].includes(item.id))
          ? [20, 45]
          : [10, 54],
      },

      colorAxis: {
        min: 0,
        stops: [
          [0, "#E6A532"], // Orange (lowest values)
          [0.25, "#F0CD91"], // Light orange
          [0.5, "#AAB9E1"], // Light blue
          [0.75, "#6487C3"], // Medium blue
          [1, "#2D50A0"], // Dark blue (highest values)
        ],
      },

      tooltip: {
        useHTML: true,
        formatter: function () {
          // Check if it's an EU27 country
          if (eu27Countries.includes(this.point.id)) {
            return " <b>EU27</b><br/>value: <b>" + this.point.value + "</b>";
          } else {
            // For non-EU countries (Japan, China, USA)
            return (
              "<b>" +
              this.point.name +
              "</b><br/>value: <b>" +
              this.point.value +
              "</b>"
            );
          }
        },
      },
      legend: {
        enabled: true,
        floating: true,
        // align: "left",
        //   verticalAlign: "bottom",
        layout: "horizontal",
        //  borderWidth: 2,
        // backgroundColor: "lightgray",
        transparent: true,
        borderColor: "white",
        itemStyle: {
          fontSize: "0.8rem",
        },
      },
      series: [
        {
          // Base layer - all countries without labels
          mapData: topology,
          allAreas: true,
          nullColor: "#f0f0f0",
          borderColor: "#ffffff",
          borderWidth: 0.5,
          name: "All Countries",
          enableMouseTracking: false,
          dataLabels: {
            enabled: false,
          },
        },
        {
          // Data layer - only countries with data and labels
          data: data,
          mapData: topology,
          joinBy: ["hc-key", "id"],
          allAreas: false,

          name: "Countries with data",
          states: {
            hover: {
              color: "#BADA55",
            },
          },
          dataLabels: {
            enabled: false,
            style: {
              textOutline: "none", // Removes the contrasting outline
            },
            backgroundColor: null,
            formatter: function () {
              return this.point.name;
            },
          },
          point: {
            events: {
              mouseOver: function () {
                // Only highlight all EU27 countries when hovering over EU countries
                if (eu27Countries.includes(this.id)) {
                  const chart = this.series.chart;
                  eu27Countries.forEach((countryId) => {
                    const point = chart.get(countryId);
                    if (point) point.setState("hover");
                  });
                }
                // For non-EU countries (Japan, China, USA), just highlight themselves
              },
              mouseOut: function () {
                // Reset hover state for all EU27 countries if this was an EU country
                if (eu27Countries.includes(this.id)) {
                  const chart = this.series.chart;
                  eu27Countries.forEach((countryId) => {
                    const point = chart.get(countryId);
                    if (point) point.setState("");
                  });
                }
                // For non-EU countries, the default behavior will handle the reset
              },
            },
          },
        },
      ],
    });
  })();
</script>
<style>
  #container {
    height: 700px;
    min-width: 310px;
    max-width: 800px;
    margin: 0 auto;
  }

  .loading {
    margin-top: 10em;
    text-align: center;
    color: gray;
  }
</style>
